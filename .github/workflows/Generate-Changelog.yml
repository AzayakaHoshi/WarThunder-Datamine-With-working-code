name: Generate Detailed Changelog with Old and New Values

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  generate-changelog:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository with Full History
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Fetch the entire commit history to ensure we capture everything

      - name: Generate Changelog with Detailed Changes
        run: |
          echo "Generating changelog for aces.vromfs.bin_u directory..."

          # Create a new changelog file
          echo "### 📝 Full Changelog for aces.vromfs.bin_u" > CHANGELOG.md
          echo "" >> CHANGELOG.md

          # Get the last two commit hashes that affected the aces.vromfs.bin_u directory
          COMMIT_HASHES=$(git log --pretty=format:"%h" -- aces.vromfs.bin_u)

          # Extract the first and second commit hash
          FIRST_COMMIT=$(echo "$COMMIT_HASHES" | sed -n '1p')
          SECOND_COMMIT=$(echo "$COMMIT_HASHES" | sed -n '2p')

          if [ -n "$FIRST_COMMIT" ] && [ -n "$SECOND_COMMIT" ]; then
            # Add commit information
            echo "#### 🔄 Commit Details" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            git log --pretty=format:"- **Commit %h**: _%s_ by %an on %ad" --date=short $SECOND_COMMIT..$FIRST_COMMIT -- aces.vromfs.bin_u >> CHANGELOG.md

            echo "" >> CHANGELOG.md

            # Generate diff summary for better readability (file names and brief changes)
            echo "#### 📂 Changes Between the Last Two Commits" >> CHANGELOG.md
            echo "" >> CHANGELOG.md

            # Output detailed changes with old/new values
            git diff $SECOND_COMMIT..$FIRST_COMMIT -- aces.vromfs.bin_u | grep -E "^\+|^\-" | sed -e 's/^-/old: /' -e 's/^+/new: /' >> CHANGELOG.md

            echo "---" >> CHANGELOG.md
          else
            echo "❗ Not enough relevant commits found to generate a changelog." >> CHANGELOG.md
          fi

      - name: Commit Changelog
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add CHANGELOG.md  # Add the changelog
          git commit -m "Generated Changelog for aces.vromfs.bin_u [skip ci]" || echo "No changes to commit."
          git push origin HEAD:$(git rev-parse --abbrev-ref HEAD) --no-verify
